/**
 * SCRIPT DE EXTRA√á√ÉO DE DADOS DE ENDERE√áO
 * ========================================
 * 
 * Este script extrai dados completos de um endere√ßo usando:
 * - Google Geocoding API (converte endere√ßo em coordenadas)
 * - OpenStreetMap Nominatim (reverse geocoding para CEP)
 * - BrasilAPI V2 (obt√©m dados completos do CEP)
 * 
 * Resultado: Objeto com todos os dados do endere√ßo
 */

// ============================================
// INTERFACE DE DADOS (TypeScript/JSDoc)
// ============================================
/**
 * @typedef {Object} LocationData
 * @property {string} address - Endere√ßo completo formatado
 * @property {number} latitude - Latitude da localiza√ß√£o
 * @property {number} longitude - Longitude da localiza√ß√£o
 * @property {string} [cep] - CEP (C√≥digo de Endere√ßamento Postal)
 * @property {string} [state] - Estado (UF)
 * @property {string} [city] - Cidade
 * @property {string} [neighborhood] - Bairro
 * @property {string} [street] - Rua/Logradouro
 * @property {string} [service] - Servi√ßo que forneceu os dados
 */

// ============================================
// FUN√á√ÉO PRINCIPAL: GEOCODIFICAR ENDERE√áO
// ============================================
/**
 * Geocodifica um endere√ßo usando Google Geocoding API
 * e extrai todos os dados relevantes
 * 
 * @param {string} addressText - Endere√ßo completo (ex: "Rua das Flores, 123, S√£o Paulo, SP")
 * @param {google.maps.Map} map - Inst√¢ncia do Google Maps
 * @returns {Promise<LocationData>} Dados da localiza√ß√£o encontrada
 */
async function geocodeAddress(addressText, map) {
  return new Promise((resolve, reject) => {
    if (!map) {
      reject(new Error("Mapa n√£o est√° pronto"));
      return;
    }

    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: addressText }, async (results, status) => {
      if (status === "OK" && results && results[0]) {
        try {
          const result = results[0];
          const lat = result.geometry.location.lat();
          const lng = result.geometry.location.lng();
          const formattedAddress = result.formatted_address;

          // ============================================
          // ETAPA 1: EXTRAIR COMPONENTES DO ENDERE√áO
          // ============================================
          let street = "";
          let city = "";
          let state = "";
          let neighborhood = "";

          result.address_components.forEach((component) => {
            // Rua/Logradouro
            if (component.types.includes("route")) {
              street = component.long_name;
            }
            // Cidade (administrative_area_level_2)
            if (component.types.includes("administrative_area_level_2")) {
              city = component.long_name;
            }
            // Estado (administrative_area_level_1)
            if (component.types.includes("administrative_area_level_1")) {
              state = component.short_name;
            }
            // Bairro (sublocality_level_1)
            if (component.types.includes("sublocality_level_1")) {
              neighborhood = component.long_name;
            }
          });

          console.log("üìç Componentes extra√≠dos do Google Geocoding:");
          console.log(`   Rua: ${street}`);
          console.log(`   Bairro: ${neighborhood}`);
          console.log(`   Cidade: ${city}`);
          console.log(`   Estado: ${state}`);
          console.log(`   Lat: ${lat}, Lng: ${lng}`);

          // ============================================
          // ETAPA 2: BUSCAR CEP USANDO NOMINATIM
          // ============================================
          let cepData = null;
          try {
            console.log(`üîç Buscando CEP via OpenStreetMap Nominatim...`);
            const nominatimResponse = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
            );

            if (nominatimResponse.ok) {
              const osmData = await nominatimResponse.json();
              console.log("‚úÖ Resposta Nominatim recebida:");
              console.log(osmData);

              // ============================================
              // ETAPA 3: BUSCAR DADOS COMPLETOS NA BRASILAPI
              // ============================================
              if (osmData.address && osmData.address.postcode) {
                const cep = osmData.address.postcode;
                console.log(`üìÆ CEP encontrado: ${cep}`);
                console.log(`üîó Buscando dados na BrasilAPI...`);

                const brasilApiResponse = await fetch(
                  `https://brasilapi.com.br/api/cep/v2/${cep}`
                );

                if (brasilApiResponse.ok) {
                  cepData = await brasilApiResponse.json();
                  console.log("‚úÖ Dados BrasilAPI recebidos:");
                  console.log(cepData);
                } else {
                  console.warn(`‚ö†Ô∏è CEP ${cep} n√£o encontrado na BrasilAPI`);
                }
              } else {
                console.warn("‚ö†Ô∏è CEP n√£o encontrado no Nominatim");
              }
            }
          } catch (error) {
            console.error("‚ùå Erro ao buscar CEP:", error);
          }

          // ============================================
          // ETAPA 4: MONTAR OBJETO FINAL
          // ============================================
          const locationData = {
            address: formattedAddress,
            latitude: lat,
            longitude: lng,
            street: street || cepData?.street || "",
            city: city || cepData?.city || "",
            state: state || cepData?.state || "",
            neighborhood: neighborhood || cepData?.neighborhood || "",
            cep: cepData?.cep || "",
            service: cepData?.service || "google_maps",
          };

          console.log("\n‚ú® DADOS FINAIS EXTRA√çDOS:");
          console.log(locationData);

          resolve(locationData);
        } catch (error) {
          reject(error);
        }
      } else {
        reject(new Error(`Geocode falhou: ${status}`));
      }
    });
  });
}

// ============================================
// FUN√á√ÉO: BUSCAR CEP DIRETO
// ============================================
/**
 * Busca dados de um CEP espec√≠fico na BrasilAPI
 * 
 * @param {string} cep - CEP no formato 12345678 ou 12345-678
 * @returns {Promise<Object>} Dados do CEP
 */
async function searchCEPDirect(cep) {
  try {
    console.log(`üîç Buscando CEP: ${cep}`);
    
    // Remover formata√ß√£o se houver
    const cleanCEP = cep.replace(/\D/g, "");
    
    const response = await fetch(
      `https://brasilapi.com.br/api/cep/v2/${cleanCEP}`
    );

    if (response.ok) {
      const data = await response.json();
      console.log("‚úÖ CEP encontrado:");
      console.log(data);
      return data;
    } else if (response.status === 404) {
      throw new Error("CEP n√£o encontrado");
    } else {
      throw new Error(`Erro ${response.status}`);
    }
  } catch (error) {
    console.error("‚ùå Erro ao buscar CEP:", error);
    throw error;
  }
}

// ============================================
// FUN√á√ÉO: REVERSE GEOCODING (Coordenadas ‚Üí CEP)
// ============================================
/**
 * Encontra CEP a partir de coordenadas
 * 
 * @param {number} latitude - Latitude
 * @param {number} longitude - Longitude
 * @returns {Promise<Object>} Dados do CEP mais pr√≥ximo
 */
async function findCEPByCoordinates(latitude, longitude) {
  try {
    console.log(`üó∫Ô∏è Buscando CEP para: Lat ${latitude}, Lng ${longitude}`);
    
    // Usar Nominatim para reverse geocoding
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
    );

    if (response.ok) {
      const osmData = await response.json();
      
      if (osmData.address && osmData.address.postcode) {
        const cep = osmData.address.postcode;
        console.log(`üìÆ CEP encontrado: ${cep}`);
        
        // Buscar dados completos na BrasilAPI
        return await searchCEPDirect(cep);
      } else {
        throw new Error("CEP n√£o encontrado nas coordenadas");
      }
    }
  } catch (error) {
    console.error("‚ùå Erro ao buscar CEP por coordenadas:", error);
    throw error;
  }
}

// ============================================
// FUN√á√ÉO: FORMATAR DADOS PARA EXIBI√á√ÉO
// ============================================
/**
 * Formata dados de localiza√ß√£o para exibi√ß√£o leg√≠vel
 * 
 * @param {LocationData} data - Dados da localiza√ß√£o
 * @returns {string} HTML formatado
 */
function formatLocationHTML(data) {
  return `
    <div style="font-family: Arial, sans-serif; line-height: 1.6;">
      <h3 style="color: #0066FF; margin-bottom: 10px;">üìç Localiza√ß√£o Encontrada</h3>
      
      <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
        <strong>Endere√ßo:</strong> ${data.address}<br/>
        <strong>Rua:</strong> ${data.street}<br/>
        <strong>Bairro:</strong> ${data.neighborhood}<br/>
        <strong>Cidade:</strong> ${data.city}<br/>
        <strong>Estado:</strong> ${data.state}<br/>
        <strong>CEP:</strong> <code style="background: #e0e0e0; padding: 2px 5px;">${data.cep}</code>
      </div>
      
      <div style="background: #f0f8ff; padding: 10px; border-radius: 5px;">
        <strong>Coordenadas:</strong><br/>
        Latitude: <code>${data.latitude.toFixed(6)}</code><br/>
        Longitude: <code>${data.longitude.toFixed(6)}</code><br/>
        <strong>Fonte:</strong> ${data.service}
      </div>
    </div>
  `;
}

// ============================================
// FUN√á√ÉO: EXPORTAR DADOS EM JSON
// ============================================
/**
 * Exporta dados de localiza√ß√£o em JSON
 * 
 * @param {LocationData} data - Dados da localiza√ß√£o
 * @param {string} [filename] - Nome do arquivo (padr√£o: location.json)
 */
function exportLocationJSON(data, filename = "location.json") {
  const jsonString = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonString], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
  console.log("‚úÖ Arquivo exportado:", filename);
}

// ============================================
// FUN√á√ÉO: EXPORTAR DADOS EM CSV
// ============================================
/**
 * Exporta dados de localiza√ß√£o em CSV
 * 
 * @param {LocationData} data - Dados da localiza√ß√£o
 * @param {string} [filename] - Nome do arquivo (padr√£o: location.csv)
 */
function exportLocationCSV(data, filename = "location.csv") {
  const csv = `Campo,Valor
Endere√ßo,${data.address}
Rua,${data.street}
Bairro,${data.neighborhood}
Cidade,${data.city}
Estado,${data.state}
CEP,${data.cep}
Latitude,${data.latitude}
Longitude,${data.longitude}
Fonte,${data.service}`;

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
  console.log("‚úÖ Arquivo exportado:", filename);
}

// ============================================
// EXEMPLO DE USO
// ============================================
/*
// Exemplo 1: Geocodificar endere√ßo
const map = new google.maps.Map(document.getElementById("map"), {
  center: { lat: -23.5505, lng: -46.6333 },
  zoom: 12,
});

geocodeAddress("Avenida Paulista, 1000, S√£o Paulo, SP", map)
  .then((data) => {
    console.log("Dados extra√≠dos:", data);
    document.getElementById("result").innerHTML = formatLocationHTML(data);
    exportLocationJSON(data, "endereco_paulista.json");
  })
  .catch((error) => {
    console.error("Erro:", error);
  });

// Exemplo 2: Buscar CEP direto
searchCEPDirect("01310930")
  .then((data) => {
    console.log("CEP encontrado:", data);
  })
  .catch((error) => {
    console.error("Erro:", error);
  });

// Exemplo 3: Encontrar CEP por coordenadas
findCEPByCoordinates(-23.5505, -46.6333)
  .then((data) => {
    console.log("CEP encontrado:", data);
  })
  .catch((error) => {
    console.error("Erro:", error);
  });
*/

// ============================================
// EXPORTAR FUN√á√ïES (para uso em m√≥dulos)
// ============================================
if (typeof module !== "undefined" && module.exports) {
  module.exports = {
    geocodeAddress,
    searchCEPDirect,
    findCEPByCoordinates,
    formatLocationHTML,
    exportLocationJSON,
    exportLocationCSV,
  };
}
