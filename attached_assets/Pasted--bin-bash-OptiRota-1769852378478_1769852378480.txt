#!/bin/bash

# ==========================================================================
# OptiRota - Instalador Definitivo (Debian/Ubuntu)
# Versao: 3.5 (Estável - Cloudflare Tunnel Edition)
# Desenvolvido para: Luis - Santos/SP
# ==========================================================================

set -e

# GARANTIR PATH DO SISTEMA (Resolve erros de comandos não encontrados)
export PATH=$PATH:/usr/local/sbin:/usr/sbin:/sbin

# Cores para saída
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'
BOLD='\033[1m'

INSTALL_DIR="/opt/optirota"
REPO_URL="https://github.com/luishplleite/rota-certa.git"

print_header() {
    clear
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║          OPTIROTA - INSTALADOR AUTOMATICO (CLOUDFLARE)           ║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════════╝${NC}"
}

print_step() {
    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}[$1/$2]${NC} $3"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Verificar se é root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Erro: Execute como root (sudo ./instalador.sh)${NC}"
    exit 1
fi

print_header
TOTAL_STEPS=9

# PASSO 1: Cloudflared e Dependências
print_step 1 $TOTAL_STEPS "Instalando dependencias e Cloudflared..."
apt-get update -qq
apt-get install -y -qq curl wget git nginx docker-compose-plugin psmisc

# Instalação direta do binário do Cloudflared para evitar problemas de repositório
ARCH=$(uname -m)
if [[ "$ARCH" == "x86_64" ]]; then CF_BIN="cloudflared-linux-amd64"; else CF_BIN="cloudflared-linux-arm64"; fi

wget -q "https://github.com/cloudflare/cloudflared/releases/latest/download/$CF_BIN" -O /usr/local/bin/cloudflared
chmod +x /usr/local/bin/cloudflared
echo -e "${GREEN}Cloudflared instalado com sucesso!${NC}"

# PASSO 2: Limpeza de portas
print_step 2 $TOTAL_STEPS "Limpando processos na porta 5000..."
fuser -k 5000/tcp || true

# PASSO 3: Download do Código
print_step 3 $TOTAL_STEPS "Baixando codigo do OptiRota..."
if [ -d "$INSTALL_DIR" ]; then 
    mv "$INSTALL_DIR" "${INSTALL_DIR}_old_$(date +%s)"
fi
git clone --depth 1 "$REPO_URL" "$INSTALL_DIR"
cd "$INSTALL_DIR"

# PASSO 4: Variáveis de Ambiente
print_step 4 $TOTAL_STEPS "Configurando variaveis de ambiente (.env)..."
read -p "SUPABASE_URL: " supabase_url
read -p "SUPABASE_SERVICE_ROLE_KEY: " supabase_key
read -p "MAPBOX_ACCESS_TOKEN: " mapbox_token
read -p "Subdominio (ex: rota.timepulseai.com.br): " domain_name

cat << EOF > .env
SUPABASE_URL=$supabase_url
SUPABASE_SERVICE_ROLE_KEY=$supabase_key
VITE_MAPBOX_TOKEN=$mapbox_token
NODE_ENV=production
PORT=5000
SESSION_SECRET=$(openssl rand -base64 32)
DOMAIN=$domain_name
EOF

# PASSO 5: Dockerfile e Compose
print_step 5 $TOTAL_STEPS "Preparando containers Docker..."
cat << 'EOF' > Dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
ARG VITE_MAPBOX_TOKEN
ENV VITE_MAPBOX_TOKEN=$VITE_MAPBOX_TOKEN
RUN npm run build
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY --from=builder /app/dist ./dist
EXPOSE 5000
CMD ["node", "dist/index.cjs"]
EOF

cat << 'EOF' > docker-compose.yml
services:
  optirota:
    build: 
      context: .
      args:
        - VITE_MAPBOX_TOKEN=${VITE_MAPBOX_TOKEN}
    container_name: optirota-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:5000:5000"
    env_file: .env
EOF

# PASSO 6: Build e Run
print_step 6 $TOTAL_STEPS "Iniciando a aplicacao via Docker..."
docker compose up -d --build

# PASSO 7: Nginx Local Proxy
print_step 7 $TOTAL_STEPS "Configurando Nginx como Gateway local..."
cat << EOF > /etc/nginx/sites-available/optirota
server {
    listen 80;
    server_name $domain_name;
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF
ln -sf /etc/nginx/sites-available/optirota /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default || true
systemctl restart nginx

# PASSO 8: Cloudflare Tunnel (Acesso Externo)
print_step 8 $TOTAL_STEPS "Configurando acesso externo (Cloudflare Tunnel)..."
echo -e "${YELLOW}Por favor, autentique no link que aparecera abaixo:${NC}"
cloudflared tunnel login

TUNNEL_NAME="optirota-tunnel-vps"
# Remove se já existir para evitar erro de nome duplicado
cloudflared tunnel delete -f $TUNNEL_NAME >/dev/null 2>&1 || true

# Cria o túnel e captura o ID
TUNNEL_OUTPUT=$(cloudflared tunnel create $TUNNEL_NAME)
TUNNEL_ID=$(echo "$TUNNEL_OUTPUT" | grep -oE "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}")

mkdir -p /etc/cloudflared
cat << EOF > /etc/cloudflared/config.yml
tunnel: $TUNNEL_ID
credentials-file: /root/.cloudflared/$TUNNEL_ID.json

ingress:
  - hostname: $domain_name
    service: http://localhost:80
  - service: http_status:404
EOF

# Rota DNS e Instalação do Serviço
cloudflared tunnel route dns $TUNNEL_NAME $domain_name
cloudflared service install || true
systemctl enable cloudflared
systemctl restart cloudflared

# PASSO 9: Finalização
print_step 9 $TOTAL_STEPS "Instalacao finalizada!"
echo -e "${GREEN}SISTEMA ONLINE E SEGURO!${NC}"
echo -e "Link de Acesso: ${BOLD}https://$domain_name${NC}"
echo -e "Para ver logs:  ${YELLOW}docker logs -f optirota-app${NC}"