# Documentação Completa - BrasilAPI com Geolocalização

## Visão Geral

A **BrasilAPI** é uma API pública brasileira que fornece dados de CEP, CNPJ, bancos, câmbio e muito mais. Este documento foca especialmente na busca de CEP com geolocalização, que permite localizar endereços e suas coordenadas geográficas (latitude e longitude).

---

## Endpoints Principais de CEP

### 1. CEP V2 - Com Geolocalização (Recomendado)

O endpoint V2 retorna informações completas de endereço incluindo coordenadas geográficas precisas.

#### URL
```
GET https://brasilapi.com.br/api/cep/v2/{cep}
```

#### Parâmetros
- **cep** (string, obrigatório): CEP a ser consultado com exatamente 8 dígitos
  - Formato aceito: `01310930` ou `01310-930`
  - Exemplo: `89010025`

#### Códigos de Resposta
- **200 OK**: Sucesso - CEP encontrado com geolocalização
- **400 Bad Request**: CEP inválido ou mal formatado
- **404 Not Found**: CEP não encontrado em nenhum provedor
- **500 Internal Server Error**: Erro interno no serviço

#### Exemplo de Requisição
```bash
curl -X GET "https://brasilapi.com.br/api/cep/v2/89010025"
```

#### Exemplo de Resposta (200 OK)
```json
{
  "cep": "89010025",
  "state": "SC",
  "city": "Blumenau",
  "neighborhood": "Centro",
  "street": "Rua Doutor Luiz de Freitas Melro",
  "service": "viacep",
  "location": {
    "type": "Point",
    "coordinates": {
      "latitude": -26.9244749,
      "longitude": -49.0629788
    }
  }
}
```

#### Campos da Resposta
| Campo | Tipo | Descrição |
|-------|------|-----------|
| cep | string | CEP consultado no formato XXXXX-XXX |
| state | string | Sigla do estado (ex: SC, SP, RJ) |
| city | string | Nome da cidade |
| neighborhood | string | Nome do bairro |
| street | string | Nome da rua/logradouro |
| service | string | Provedor que retornou o resultado (viacep, opencep, etc) |
| location.type | string | Tipo de geometria (sempre "Point") |
| location.coordinates.latitude | number | Latitude em formato decimal |
| location.coordinates.longitude | number | Longitude em formato decimal |

---

### 2. CEP V1 - Dados Básicos (Legado)

O endpoint V1 retorna apenas informações de endereço, sem geolocalização.

#### URL
```
GET https://brasilapi.com.br/api/cep/v1/{cep}
```

#### Exemplo de Resposta
```json
{
  "cep": "89010025",
  "state": "SC",
  "city": "Blumenau",
  "neighborhood": "Centro",
  "street": "Rua Doutor Luiz de Freitas Melro",
  "service": "viacep"
}
```

---

## Implementação em JavaScript/TypeScript

### Exemplo Básico com Fetch API

```typescript
async function searchCEP(cep: string) {
  // Remover formatação
  const cleanCep = cep.replace(/\D/g, "");
  
  // Validar
  if (cleanCep.length !== 8) {
    console.error("CEP deve conter 8 dígitos");
    return;
  }

  try {
    const response = await fetch(
      `https://brasilapi.com.br/api/cep/v2/${cleanCep}`
    );

    if (!response.ok) {
      if (response.status === 404) {
        throw new Error("CEP não encontrado");
      } else if (response.status === 400) {
        throw new Error("CEP inválido ou mal formatado");
      } else {
        throw new Error("Erro ao buscar CEP");
      }
    }

    const data = await response.json();
    console.log("Endereço encontrado:", data);
    
    // Usar coordenadas
    const { latitude, longitude } = data.location.coordinates;
    console.log(`Localização: ${latitude}, ${longitude}`);
    
    return data;
  } catch (error) {
    console.error("Erro:", error);
  }
}

// Uso
searchCEP("89010025");
```

### Exemplo com Axios

```typescript
import axios from "axios";

async function searchCEPAxios(cep: string) {
  try {
    const cleanCep = cep.replace(/\D/g, "");
    
    const { data } = await axios.get(
      `https://brasilapi.com.br/api/cep/v2/${cleanCep}`
    );
    
    console.log("Endereço:", data);
    return data;
  } catch (error) {
    if (axios.isAxiosError(error)) {
      console.error("Erro HTTP:", error.response?.status, error.message);
    } else {
      console.error("Erro:", error);
    }
  }
}
```

---

## Integração com Google Maps

### Exemplo Completo: Buscar CEP e Exibir no Mapa

```typescript
import { MapView } from "@/components/Map";
import { useRef, useState } from "react";

export function CEPMapViewer() {
  const mapRef = useRef<google.maps.Map | null>(null);
  const markerRef = useRef<google.maps.marker.AdvancedMarkerElement | null>(null);
  const [cepData, setCepData] = useState(null);

  const handleMapReady = (map: google.maps.Map) => {
    mapRef.current = map;
    map.setCenter({ lat: -14.2350, lng: -51.9253 }); // Centro do Brasil
    map.setZoom(4);
  };

  const searchAndShowOnMap = async (cep: string) => {
    const cleanCep = cep.replace(/\D/g, "");
    
    try {
      const response = await fetch(
        `https://brasilapi.com.br/api/cep/v2/${cleanCep}`
      );
      
      if (!response.ok) throw new Error("CEP não encontrado");
      
      const data = await response.json();
      setCepData(data);

      // Extrair coordenadas
      const { latitude, longitude } = data.location.coordinates;
      const location = { lat: latitude, lng: longitude };

      // Remover marcador anterior
      if (markerRef.current) {
        markerRef.current.map = null;
      }

      // Criar novo marcador
      markerRef.current = new google.maps.marker.AdvancedMarkerElement({
        map: mapRef.current,
        position: location,
        title: `${data.street}, ${data.city}`,
      });

      // Centralizar mapa
      mapRef.current.setCenter(location);
      mapRef.current.setZoom(15);

      // Adicionar infowindow
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="padding: 10px; font-family: Arial;">
            <strong>${data.street}</strong><br/>
            ${data.neighborhood}, ${data.city} - ${data.state}<br/>
            <code>${data.cep}</code>
          </div>
        `,
      });

      markerRef.current.addListener("click", () => {
        infoWindow.open(mapRef.current, markerRef.current);
      });

    } catch (error) {
      console.error("Erro:", error);
    }
  };

  return (
    <div>
      <input 
        type="text" 
        placeholder="Digite um CEP"
        onBlur={(e) => searchAndShowOnMap(e.target.value)}
      />
      <MapView onMapReady={handleMapReady} />
    </div>
  );
}
```

---

## Tratamento de Erros

### Cenários Comuns

#### 1. CEP Não Encontrado (404)
```typescript
if (response.status === 404) {
  console.error("CEP não encontrado em nenhum provedor");
  // Sugerir ao usuário verificar o CEP
}
```

#### 2. CEP Inválido (400)
```typescript
if (response.status === 400) {
  console.error("CEP mal formatado - deve conter 8 dígitos");
  // Validar entrada do usuário
}
```

#### 3. Erro de Rede
```typescript
try {
  const response = await fetch(url);
} catch (error) {
  console.error("Erro de conexão com a API");
  // Implementar retry ou fallback
}
```

---

## Boas Práticas

### 1. Formatação de CEP
```typescript
function formatCEP(cep: string): string {
  const clean = cep.replace(/\D/g, "");
  if (clean.length !== 8) return "";
  return `${clean.slice(0, 5)}-${clean.slice(5)}`;
}

// Uso
console.log(formatCEP("89010025")); // "89010-025"
```

### 2. Validação de CEP
```typescript
function isValidCEP(cep: string): boolean {
  const clean = cep.replace(/\D/g, "");
  return clean.length === 8 && /^\d+$/.test(clean);
}
```

### 3. Cache de Resultados
```typescript
const cepCache = new Map<string, any>();

async function searchCEPWithCache(cep: string) {
  const clean = cep.replace(/\D/g, "");
  
  // Verificar cache
  if (cepCache.has(clean)) {
    return cepCache.get(clean);
  }

  // Buscar na API
  const response = await fetch(
    `https://brasilapi.com.br/api/cep/v2/${clean}`
  );
  const data = await response.json();
  
  // Armazenar em cache
  cepCache.set(clean, data);
  return data;
}
```

### 4. Debounce para Busca em Tempo Real
```typescript
import { useCallback, useRef } from "react";

function useDebounce(callback: Function, delay: number) {
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  return useCallback((...args: any[]) => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    timeoutRef.current = setTimeout(() => {
      callback(...args);
    }, delay);
  }, [callback, delay]);
}

// Uso
const debouncedSearch = useDebounce((cep: string) => {
  searchCEP(cep);
}, 500);
```

---

## Limitações e Considerações

### Geolocalização
- As coordenadas são fornecidas pelo **OpenStreetMap**
- Podem conter pequenos desvios em relação à localização exata
- Para correções, visite: https://www.openstreetmap.org

### Disponibilidade
- A API utiliza múltiplos provedores com sistema de fallback
- Provedores incluem: OpenCEP, ViaCEP, Correios e outros
- Sem limite de requisições para uso básico

### CORS
- A API permite requisições diretas do navegador
- Não é necessário proxy ou chave de API

---

## Exemplos de CEPs para Teste

| CEP | Cidade | Estado |
|-----|--------|--------|
| 01310-930 | São Paulo | SP |
| 20040020 | Rio de Janeiro | RJ |
| 30140071 | Belo Horizonte | MG |
| 89010-025 | Blumenau | SC |
| 70040902 | Brasília | DF |

---

## Recursos Adicionais

- **Site Oficial**: https://brasilapi.com.br
- **Documentação**: https://brasilapi.com.br/docs
- **GitHub**: https://github.com/brasilapi/brasilapi
- **OpenStreetMap**: https://www.openstreetmap.org

---

## Resumo da Implementação

Para implementar uma busca de CEP com geolocalização:

1. **Capturar entrada do usuário** - CEP formatado (00000-000)
2. **Validar** - Verificar se contém 8 dígitos
3. **Chamar API** - `GET /api/cep/v2/{cep}`
4. **Extrair coordenadas** - `location.coordinates.latitude` e `longitude`
5. **Exibir no mapa** - Usar Google Maps ou similar
6. **Mostrar detalhes** - Rua, bairro, cidade, estado
7. **Tratar erros** - 404 (não encontrado), 400 (inválido), 500 (erro)

A aplicação **BrasilAPI CEP Locator** implementa todos esses passos de forma integrada e amigável.
