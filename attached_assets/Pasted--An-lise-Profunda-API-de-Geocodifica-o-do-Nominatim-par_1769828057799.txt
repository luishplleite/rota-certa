---

# Análise Profunda: API de Geocodificação do Nominatim para Coordenadas Precisas de Ruas e Números de Casa
## Visão Geral
O Nominatim é um serviço de geocodificação baseado em dados do OpenStreetMap que permite converter endereços em coordenadas geográficas (latitude e longitude) e vice-versa. Para que o Nominatim retorne coordenadas precisas baseadas em nomes de rua e números específicos de casa, ele combina três camadas fundamentais de processamento: análise estruturada de endereços, interpolação de números de casa e indexação espacial em banco de dados.

## Como o Nominatim Retorna Coordenadas Precisas
### Mecanismo Técnico de Geocodificação
O Nominatim processa endereços através de dois fluxos principais: consultas em formato livre (`q=endereço`) e consultas estruturadas. Para máxima precisão, as consultas estruturadas são superiores, pois permitem especificar componentes discretos do endereço através de parâmetros dedicados: [nominatim](https://nominatim.org/release-docs/latest/api/Search/)

| Parâmetro | Descrição | Exemplo |
|-----------|-----------|---------|
| `street` | Número da casa + nome da rua | `street=135 Pilkington Avenue` |
| `city` | Cidade ou município | `city=Birmingham` |
| `country` | País (código ISO) | `country=gb` |
| `postalcode` | CEP ou código postal | `postalcode=B72` |

A vantagem da query estruturada é que reduz complexidade computacional. Ao invés de processar uma string de texto da esquerda para direita e depois da direita para esquerda (como ocorre em buscas livres), o Nominatim aplica matching direto contra índices de banco de dados indexados por componente. [nominatim](https://nominatim.org/release-docs/4.2/api/Search/)

### Interpolação de Números de Casa
O Nominatim utiliza um mecanismo chamado **address interpolation** para retornar coordenadas de números de casa que não possuem entrada explícita no OpenStreetMap. Este sistema funciona através de dois nós na rua com números conhecidos: [nominatim](https://nominatim.org/release-docs/latest/develop/Database-Layout/)

**Estrutura de Dados (location_property_osmline)**:
- `startnumber`: primeiro número do range (ex: 2)
- `endnumber`: último número do range (ex: 100)
- `interpolationtype`: tipo de sequência (`odd`, `even`, ou `all`)
- Coordenadas interpoladas linearmente ao longo da way (linha da rua)

**Exemplo Prático**: Se uma rua tiver nó no número 2 (lat: -23.550, lon: -46.633) e nó no número 100 (lat: -23.551, lon: -46.635), uma consulta pelo número 50 resultará em coordenadas calculadas aproximadamente no meio do segmento.

Limitação conhecida: Nominatim rejeita interpolação de mais de 1000 números em um único segmento de rua, como proteção contra dados malformados. [github](https://github.com/openstreetmap/Nominatim/issues/49)

### Fonte de Dados: OSM + TIGER
Para os EUA, o Nominatim complementa dados do OpenStreetMap com dados TIGER (Topologically Integrated Geographic Encoding and Referencing) do Censo Americano. Estes dados federais fornecem ranges de números de casa de alta qualidade, adicionando aproximadamente 10GB ao banco de dados. [nominatim](https://nominatim.org/release-docs/latest/customize/Tiger/)

Em outras regiões, a precisão depende inteiramente da cobertura do OSM, que é altamente variável. No Brasil, por exemplo, estudos documentam que a precisão de endereços é problemática, especialmente em áreas rurais. [sol.sbc.org](https://sol.sbc.org.br/journals/index.php/jidm/article/download/2092/1814/7469)
## Requisição Estruturada para Máxima Precisão
Para consultas que visam coordenadas precisas de números de casa, a seguinte estrutura de URL é recomendada:

```
https://nominatim.openstreetmap.org/search?
  street=<housenumber> <streetname>
  &city=ity>
  &country=untry>
  &postalcode=<postalcode>
  &format=json
  &addressdetails=1
  &limit=1
```

**Parâmetros Críticos para Precisão**:

- **`format=json`**: retorna resposta em JSON estruturado com componentes de endereço separados [nominatim](https://nominatim.org/release-docs/4.2/api/Search/)
- **`addressdetails=1`**: inclui breakdown detalhado do endereço em elementos (house_number, road, suburb, city, postcode)
- **`limit=1`**: retorna apenas o melhor match, evitando ambiguidade
- **Sem `q=`**: nunca combine query estruturada com free-form query

### Exemplo de Resposta Estruturada
```json
{
  "lat": "52.5487921",
  "lon": "-1.8164308",
  "place_id": 125279639,
  "osm_type": "way",
  "osm_id": 90394480,
  "display_name": "135, Pilkington Avenue, Maney, Sutton Coldfield...",
  "address": {
    "house_number": "135",
    "road": "Pilkington Avenue",
    "village": "Wylde Green",
    "city": "Birmingham",
    "postcode": "B72 1LH",
    "country": "United Kingdom"
  }
}
```

## Reverse Geocoding (Coordenadas para Endereço)
Para situação inversa—quando você possui coordenadas e deseja encontrar o endereço com número de casa—o Nominatim usa o parâmetro `zoom` para controlar granularidade: [nominatim](https://nominatim.org/release-docs/latest/api/Reverse/)

A precisão reverse é controlada pelo parâmetro `zoom`:

```
https://nominatim.openstreetmap.org/reverse?
  lat=52.5487429&lon=-1.8160209
  &zoom=18
  &addressdetails=1
  &format=json
```

**Zoom=18** (nível máximo) retorna endereços com precisão de **building**, incluindo números de casa quando disponíveis no banco de dados. Zoom=16-17 retorna apenas nome de rua (major/minor streets), enquanto zoom inferior a 16 retorna apenas cidade ou borough.

## Limitações de Precisão por Região
### Brasil: Desafio Crítico
Pesquisa acadêmica documentou que em cenários brasileiros, especialmente rurais: [sol.sbc.org](https://sol.sbc.org.br/journals/index.php/jidm/article/download/2092/1814/7469)

- **Nominatim retorna 96.15% de códigos de CEP incorretos** em áreas rurais de São Paulo
- **Cobertura de números de casa é extremamente escassa** fora de grandes centros urbanos
- **Endereços sintéticos**: Nominatim gera endereços computacionalmente, não são oficiais

Recomendação para Brasil: sempre validar com banco de dados da Correios ou CEP Aberto em paralelo. [sol.sbc.org](https://sol.sbc.org.br/journals/index.php/jidm/article/download/2092/1814/7469)

### Cobertura Global
- **EUA**: excelente (TIGER data)
- **Europa Ocidental**: muito boa (contribuidores ativos)
- **Brasil e América Latina**: média a fraca, especialmente em numeração de casas
- **Regiões rurais globalmente**: fraca

## Otimizações para Máxima Precisão
### 1. Limpeza de Dados de Entrada
Antes de enviar à API Nominatim:
- Remover caracteres especiais desnecessários
- Expandir abreviações (St → Street, Av → Avenue)
- Separar número de rua do nome da rua
- Usar formato canônico de CEP

### 2. Camada de Filtro
Use o parâmetro `layer=address` para focar exclusivamente em dados de endereço: [nominatim](https://nominatim.org/release-docs/latest/api/Search/)

```
&layer=address
```

Isto exclui POIs (pontos de interesse) e estruturas não relevantes para geocodificação de endereços residenciais.

### 3. Bounding Box (viewbox)
Para áreas urbanas grandes onde há ambiguidade, use `viewbox` para preferir resultados em região específica:

```
&viewbox=<lon1>,<lat1>,<lon2>,<lat2>
```

### 4. Exclude Place IDs
Se o resultado for incorreto e você obtiver um `place_id` errado, exclua-o em próximas consultas:

```
&exclude_place_ids=<wrong_place_id>
```

### 5. Validação Pós-Processamento
Sempre implementar validação:
- Comparar distância entre coordenada retornada e coordenadas de referência (se disponíveis)
- Verificar se `house_number` no response corresponde ao input
- Em Brasil, validar CEP contra banco oficial

## Arquitetura de Banco de Dados do Nominatim
O Nominatim armazena três tipos de dados de endereço em tabelas separadas: [nominatim](https://nominatim.org/release-docs/latest/develop/Database-Layout/)

1. **placex**: pontos e ways nomeados (ruas, cidades, limites)
2. **location_property_osmline**: interpolações de números de casa com `startnumber`, `endnumber`, `interpolationtype`
3. **location_property_tiger**: dados TIGER (apenas importados em instâncias com TIGER habilitado)

Ao indexar, o Nominatim tokeniza endereços em termos de busca usando funções de tokenizer customizáveis, criando índices invertidos para acesso rápido.

## Casos de Uso e Recomendações Finais
**Para Aplicações de Entrega / E-commerce**:
- Usar geocodificação reversa (zoom=18) após capturar coordenadas do mapa
- Implementar fallback para APIs comerciais (Google, HERE) em regiões de baixa cobertura
- Em Brasil, integrar com API da Correios para validação de CEP

**Para Análise de Dados de Endereços em Lote**:
- Usar query estruturada com rate limiting (máximo 1 req/seg conforme ToS)
- Implementar cache local de resultados já consultados
- Em Brasil, considerar alternativas como Pelias (que combina OSM, TIGER, WhosOnFirst, OpenAddresses)

**Para Aplicações que Requerem Alta Precisão**:
- Nunca confiar exclusivamente em Nominatim para endereços críticos (billing, shipping legal)
- Implementar múltiplas camadas de validação
- Em regiões com cobertura baixa, usar serviços de dados de endereço curados (GeoPostcodes, HERE, Google)

O Nominatim é excelente como solução gratuita e de código aberto, mas suas limitações de precisão—especialmente fora de regiões urbanas desenvolvidas—devem ser consideradas no design de arquitetura de aplicação.